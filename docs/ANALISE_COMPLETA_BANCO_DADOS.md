# An√°lise Completa do Sistema Multi-Empresas - Banco de Dados

## üèóÔ∏è ARQUITETURA GERAL

### Conceito Multi-Tenant
O sistema √© projetado como **multi-tenant**, onde cada cl√≠nica opera de forma completamente isolada atrav√©s de:
- **`clinica_id`**: Campo presente em TODAS as tabelas principais para garantir isolamento
- **Row Level Security (RLS)**: Pol√≠ticas no banco que filtram automaticamente os dados por cl√≠nica
- **Sess√µes isoladas**: Cada login estabelece contexto espec√≠fico da cl√≠nica

---

## üìä ESTRUTURA DAS TABELAS PRINCIPAIS

### 1. **TABELAS ADMINISTRATIVAS**

#### `admin_users` - Administradores do Sistema
- **Fun√ß√£o**: Usu√°rios que gerenciam o sistema como um todo
- **Campos cr√≠ticos**: `email`, `password_hash`, `salt`, `failed_attempts`, `locked_until`
- **Seguran√ßa**: Hash com salt, bloqueio ap√≥s tentativas, RLS restritivo

#### `admin_sessions` - Sess√µes Administrativas  
- **Fun√ß√£o**: Controla sess√µes ativas dos administradores
- **Campos**: `session_token`, `expires_at`, `ip_address`, `user_agent`
- **Isolamento**: Cada admin s√≥ v√™ suas pr√≥prias sess√µes

#### `admin_logs` - Logs Administrativos
- **Fun√ß√£o**: Registra todas as a√ß√µes administrativas
- **Campos**: `acao`, `detalhes` (JSONB), `admin_session_id`, `ip_address`
- **Auditoria**: Log completo de a√ß√µes para compliance

---

### 2. **TABELAS DE CL√çNICAS**

#### `clinicas` - Registro Principal das Cl√≠nicas
```sql
Campos principais:
- id (UUID) - Identificador √∫nico
- nome - Nome da cl√≠nica
- email - Email principal (usado para login)
- telefone, endereco - Dados de contato
- subdominio - Subdom√≠nio personalizado (√∫nico)
- foto_perfil_url - Logo/foto da cl√≠nica
```

#### `configuracoes_clinica` - Configura√ß√µes Espec√≠ficas
```sql
Configura√ß√µes importantes:
- email_login_clinica - Email de acesso
- senha_hash_secure - Senha hasheada (bcrypt)
- salt - Salt para criptografia
- codigo_acesso_admin/clinica/funcionario - C√≥digos √∫nicos
- verificacao_automatica - Auto-confirma√ß√£o agendamentos
- telemedicina_ativa - Teleconsultas habilitadas
- mfa_enabled - Autentica√ß√£o 2FA
- account_locked - Conta bloqueada
- failed_login_attempts - Tentativas de login
```

#### `assinaturas` - Controle de Pagamentos
```sql
Controle financeiro:
- clinica_id - Refer√™ncia √† cl√≠nica
- tipo_plano - basico, avancado, premium, trial
- periodo_meses - 1, 6, 12 meses
- status - ativa, trial, suspensa, cancelada
- valor, data_inicio, proximo_pagamento
- stripe_customer_id, stripe_subscription_id
```

---

### 3. **TABELAS DE USU√ÅRIOS**

#### `medicos` - Cadastro de M√©dicos
```sql
Isolamento: clinica_id
Campos especiais:
- crm, coren - Registros profissionais
- especialidade - √Årea m√©dica
- percentual_repasse - % de repasse por consulta
- senha_acesso - Login para portal m√©dico
- categoria_trabalho[] - Array de categorias
- ativo - Status no sistema
```

#### `funcionarios` - Funcion√°rios da Cl√≠nica
```sql
Isolamento: clinica_id
Controle:
- funcao - Cargo/fun√ß√£o
- cpf, rg - Documentos
- email, telefone - Contato
- ativo - Status
```

#### `pacientes` - Cadastro de Pacientes
```sql
Isolamento: clinica_id
Dados completos:
- cpf - Usado para login no portal
- senha_acesso - Acesso portal paciente
- convenio_id, numero_convenio - Plano de sa√∫de
- dados pessoais completos (nome, telefone, endere√ßo)
- peso, altura, idade - Dados m√©dicos
```

---

### 4. **TABELAS DE AGENDAMENTOS**

#### `agendamentos` - Sistema de Agendas
```sql
N√∫cleo do sistema:
- clinica_id, paciente_id, medico_id
- data_agendamento, horario, horario_fim
- tipo_exame - Tipo do procedimento
- status - agendado, confirmado, em_andamento, concluido, cancelado, faltou
- valor_exame, valor_pago, status_pagamento
- eh_telemedicina - Flag para teleconsultas
- observacoes, arquivo_comprovante_url
```

#### `agendamentos_historico` - Auditoria de Mudan√ßas
```sql
Rastreamento:
- agendamento_id - Refer√™ncia
- status_anterior, status_novo
- automatico - Se foi mudan√ßa autom√°tica
- detalhes (JSONB) - Dados da mudan√ßa
- clinica_id - Isolamento
```

#### `lista_espera_agendamentos` - Fila de Espera
```sql
Gest√£o de vagas:
- clinica_id, paciente_id, medico_id
- tipo_exame, data_preferencia, periodo_preferencia
- status - aguardando, chamado, agendado
- prioridade - N√≠vel de prioridade
```

#### `chamadas_lista_espera` - Controle de Chamadas
```sql
Processo de contato:
- lista_espera_id - Refer√™ncia √† espera
- data_vaga_disponivel, horario_vaga_disponivel
- metodo_contato - telefone, email, whatsapp
- contato_realizado, resposta_paciente
- prazo_resposta - Tempo limite para resposta
```

---

### 5. **TABELAS DE EXAMES**

#### `exames` - Central de Exames
```sql
Gest√£o de laudos:
- clinica_id, paciente_id, medico_id
- tipo, data_exame, status
- arquivo_url, arquivo_nome - Arquivo principal
- imagens_urls[], imagens_nomes[] - M√∫ltiplas imagens
- laudo_url, laudo_nome - Laudo m√©dico
- comentarios - Observa√ß√µes
```

#### `categorias_exames` - Tipos de Exames
```sql
Organiza√ß√£o:
- clinica_id - Isolamento
- nome, descricao
- categoria_pai_id - Hierarquia de categorias
- valor - Pre√ßo padr√£o
- ativo - Status
```

#### `exames_valores` - Pre√ßos dos Exames
```sql
Tabela de pre√ßos:
- clinica_id, tipo_exame
- valor, descricao
- ativo - Se est√° dispon√≠vel
```

---

### 6. **TABELAS M√âDICAS**

#### `receitas_medicas` - Prescri√ß√µes
```sql
Receitu√°rio:
- clinica_id, medico_id, paciente_id
- medicamentos - Prescri√ß√£o completa
- tipo_receita - basica, controlada, especial
- data_emissao, observacoes
```

#### `atestados_medicos` - Atestados
```sql
Atestados m√©dicos:
- clinica_id, medico_id, paciente_id
- tipo_atestado - medico, trabalho, escolar
- dias_afastamento, data_inicio/fim_afastamento
- cid - Classifica√ß√£o da doen√ßa
- observacoes - Detalhes m√©dicos
```

#### `anotacoes_medicas` - Prontu√°rio
```sql
Hist√≥rico m√©dico:
- clinica_id, medico_id, paciente_id
- agendamento_id - Consulta relacionada
- tipo_anotacao - consulta, retorno, emergencia
- titulo, conteudo - Anota√ß√£o m√©dica
- data_anotacao - Timestamp
```

---

### 7. **TABELAS DE TELEMEDICINA**

#### `teleconsultas` - Consultas Online
```sql
Sistema de videochamadas:
- clinica_id, agendamento_id, medico_id, paciente_id
- sala_id, daily_room_name - Identificadores da sala
- url_medico, url_paciente - Links espec√≠ficos
- status - agendada, em_andamento, finalizada
- data_inicio, data_fim, duracao_segundos
- medico_entrou_em, paciente_entrou_em
- gravacao_ativada, url_gravacao
- daily_room_config (JSONB) - Configura√ß√µes Daily.co
```

#### `teleconsulta_participantes` - Controle de Acesso
```sql
Monitoramento em tempo real:
- teleconsulta_id, usuario_id, tipo_participante
- entrou_em, saiu_em, esta_online
- camera_ativada, microfone_ativado, tela_compartilhada
- qualidade_audio, qualidade_video, latencia_ms
```

#### `teleconsultas_uso_mensal` - Controle de Limites
```sql
Faturamento:
- clinica_id, mes_referencia
- total_utilizadas - Teleconsultas usadas
- pacotes_adicionais_comprados - Pacotes extras
```

---

### 8. **TABELAS FINANCEIRAS**

#### `repasses_medicos` - Repasses aos M√©dicos
```sql
C√°lculo autom√°tico:
- clinica_id, medico_id, agendamento_id
- valor_consulta, percentual_repasse, valor_repasse
- mes_referencia, status (pendente, pago)
- data_pagamento, observacoes
```

#### `faturas_medicos_mensais` - Faturamento Extra
```sql
Cobran√ßa por m√©dicos extras:
- clinica_id, mes_referencia
- total_medicos, medicos_extras
- valor_por_medico, valor_total
- status, data_vencimento, data_pagamento
```

#### `planos_assinatura` - Planos Dispon√≠veis
```sql
Configura√ß√£o de planos:
- tipo_plano - basico, avancado, premium, trial
- periodo_meses - 1, 6, 12
- valor_base, percentual_desconto, valor_final
- limite_funcionarios, limite_medicos
- limite_teleconsultas_gratuitas
- funcionalidades_bloqueadas[]
```

---

### 9. **TABELAS DE CONTROLE**

#### `logs_acesso` - Auditoria Geral
```sql
Log de a√ß√µes:
- acao - Tipo de a√ß√£o
- tabela_afetada - Tabela modificada
- usuario_id, registro_id
- detalhes (JSONB) - Dados da a√ß√£o
- ip_address, user_agent
```

#### `email_lembretes` - Sistema de Email
```sql
Notifica√ß√µes autom√°ticas:
- clinica_id, agendamento_id
- email_paciente, status_envio
- data_envio, tentativas, erro_envio
```

#### `notificacoes_pagamento` - Cobran√ßas
```sql
Avisos de vencimento:
- clinica_id, data_vencimento
- tipo_notificacao - aviso, vencimento, corte
- status_envio, tentativas, ultimo_erro
```

---

### 10. **TABELAS DE INSCRI√á√ïES**

#### `inscricoes_pendentes` - Novas Cl√≠nicas
```sql
Processo de cadastro:
- nome_clinica, nome_responsavel
- email_responsavel, cpf_responsavel, telefone
- subdominio_solicitado - Deve ser √∫nico
- dados_completos (JSONB) - Informa√ß√µes extras
- status - pendente, aprovada, rejeitada
- processada_em, processada_por
- senha_escolhida - Senha definida pela cl√≠nica
```

---

## üîê SISTEMA DE SEGURAN√áA

### Row Level Security (RLS)
Cada tabela principal tem pol√≠ticas que garantem:
```sql
-- Exemplo de pol√≠tica padr√£o
CREATE POLICY "Isolamento por clinica" 
ON nome_tabela 
FOR ALL 
USING (clinica_id IN (
  SELECT clinicas.id 
  FROM clinicas 
  WHERE clinicas.id = nome_tabela.clinica_id
));
```

### Controle de Acesso por Tipo de Usu√°rio

#### **Administradores do Sistema**
- Acesso total ao sistema
- Podem gerenciar todas as cl√≠nicas
- Processam inscri√ß√µes de novas cl√≠nicas
- Visualizam logs e relat√≥rios globais

#### **Administradores de Cl√≠nica**
- Acesso total aos dados da sua cl√≠nica
- Gerenciam funcion√°rios, m√©dicos, pacientes
- Configura√ß√µes e relat√≥rios da cl√≠nica
- Acesso ao dashboard financeiro

#### **Funcion√°rios**
- Acesso baseado na fun√ß√£o
- Podem gerenciar agendamentos e pacientes
- Acesso limitado a relat√≥rios
- N√£o acessam configura√ß√µes cr√≠ticas

#### **M√©dicos**
- Acesso aos seus agendamentos
- Podem criar receitas e atestados
- Visualizam pacientes da cl√≠nica
- Portal espec√≠fico para teleconsultas

#### **Pacientes**
- Acesso apenas aos seus pr√≥prios dados
- Portal com exames e agendamentos
- Login com CPF + senha
- Acesso a teleconsultas agendadas

---

## üîÑ FLUXOS PRINCIPAIS

### 1. **Fluxo de Cadastro de Nova Cl√≠nica**
```mermaid
graph TD
    A[Cl√≠nica se inscreve] --> B[Dados salvos em inscricoes_pendentes]
    B --> C[Admin do sistema aprova]
    C --> D[Fun√ß√£o processar_inscricao_segura]
    D --> E[Cria registro em clinicas]
    D --> F[Cria configuracoes_clinica]
    D --> G[Cria assinatura trial]
    D --> H[Status: aprovada]
```

### 2. **Fluxo de Agendamento**
```mermaid
graph TD
    A[Cria√ß√£o do agendamento] --> B[Valida√ß√£o de conflitos]
    B --> C[Salvo com status: agendado]
    C --> D[Trigger: log_status_change]
    D --> E[Hist√≥rico registrado]
    C --> F[Se conclu√≠do: calcular_repasse_medico]
    F --> G[Repasse criado automaticamente]
```

### 3. **Fluxo de Teleconsulta**
```mermaid
graph TD
    A[Agendamento marcado como telemedicina] --> B[Trigger: incrementar_uso_teleconsulta]
    B --> C[Verificar limites do plano]
    C --> D[Criar sala Daily.co]
    D --> E[URLs geradas para m√©dico/paciente]
    E --> F[Acesso liberado 15min antes]
    F --> G[Monitoramento em tempo real]
```

---

## üö® PROBLEMAS IDENTIFICADOS

### 1. **Sistema de Inscri√ß√µes**
- ‚ùå Cl√≠nicas aprovadas podem n√£o aparecer corretamente
- ‚ùå Fun√ß√£o `processar_inscricao_segura` pode ter bugs
- ‚ùå Falta valida√ß√£o de subdom√≠nios √∫nicos

### 2. **Seguran√ßa de Senhas**
- ‚ùå Algumas cl√≠nicas ainda usam senhas padr√£o
- ‚ùå Sistema h√≠brido de hash (senha_hash vs senha_hash_secure)
- ‚ùå Falta migra√ß√£o completa para bcrypt

### 3. **Sistema de Emails**
- ‚ö†Ô∏è Configura√ß√£o presente mas precisa testes
- ‚ö†Ô∏è Templates podem n√£o estar completos
- ‚ö†Ô∏è Falta monitoramento de entregas

### 4. **Controle de Limites**
- ‚ö†Ô∏è Verifica√ß√£o de limites por plano n√£o est√° completa
- ‚ö†Ô∏è Faturamento adicional pode ter falhas

---

## üìà M√âTRICAS E RELAT√ìRIOS

O sistema gera relat√≥rios em:
- **Agendamentos**: Por per√≠odo, m√©dico, status
- **Financeiro**: Receitas, repasses, inadimpl√™ncia  
- **Operacional**: Produtividade, tempo m√©dio
- **Teleconsultas**: Uso, qualidade, limites

---

## üîß MANUTEN√á√ÉO E LIMPEZA

### Processos Autom√°ticos
- `limpar_codigos_expirados()`: Remove c√≥digos de recupera√ß√£o antigos
- `limpar_emails_antigos()`: Cancela emails com erro ap√≥s 24h
- Triggers autom√°ticos para hist√≥rico e repasses

### Monitoramento
- Logs detalhados em `logs_acesso`
- Auditoria em `agendamentos_historico`
- Sess√µes ativas em tabelas de sess√£o

---

## üéØ PR√ìXIMOS PASSOS RECOMENDADOS

1. **Corrigir fun√ß√£o de processamento de cl√≠nicas**
2. **Migrar completamente para bcrypt**
3. **Implementar valida√ß√£o rigorosa de subdom√≠nios**
4. **Testar sistema de emails em produ√ß√£o**
5. **Implementar monitoramento de limites em tempo real**
6. **Criar dashboard de sa√∫de do sistema**