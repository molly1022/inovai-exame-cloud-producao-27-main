# üì∫ Sistema de Telemedicina - Documenta√ß√£o Completa

## üìã √çndice
1. [Vis√£o Geral](#vis√£o-geral)
2. [Configura√ß√£o Inicial](#configura√ß√£o-inicial)
3. [Fluxo Completo do Sistema](#fluxo-completo-do-sistema)
4. [Libera√ß√£o de Chamadas por Planos](#libera√ß√£o-de-chamadas-por-planos)
5. [Interface Frontend](#interface-frontend)
6. [Sistema de Compra de Pacotes](#sistema-de-compra-de-pacotes)
7. [Integra√ß√£o Daily.co](#integra√ß√£o-dailyco)
8. [Troubleshooting](#troubleshooting)
9. [APIs e Webhooks](#apis-e-webhooks)

---

## üéØ Vis√£o Geral

O sistema de telemedicina permite consultas m√©dicas por videoconfer√™ncia atrav√©s da integra√ß√£o com Daily.co. Oferece controle de limites por plano, compra de pacotes adicionais e portais separados para m√©dicos e pacientes.

### ‚úÖ Funcionalidades Implementadas
- ‚úÖ **Agendamento de teleconsultas** 
- ‚úÖ **Portal do m√©dico** com controles de v√≠deo/√°udio
- ‚úÖ **Portal do paciente** com autentica√ß√£o
- ‚úÖ **Controle de limites** por plano de assinatura
- ‚úÖ **Compra de pacotes adicionais** via Mercado Pago
- ‚úÖ **Isolamento por cl√≠nica** com RLS
- ‚ö†Ô∏è **Integra√ß√£o Daily.co** (implementada, aguardando configura√ß√£o final)

---

## ‚öôÔ∏è Configura√ß√£o Inicial

### 1. **Configura√ß√£o da Cl√≠nica de Teste**

**Cl√≠nica:** `inovaiexibe@gmail.com`  
**Status:** ‚úÖ **Totalmente configurada**

```sql
-- Dados da cl√≠nica configurada
ID: d4c5cd26-ce33-445a-ab88-27edf6a069a8
Email: inovaiexibe@gmail.com
Senha: inovai123
Plano: Empresarial (sem limites)
Daily.co API Key: f9f510868a67264b3e335e29413cc6333cd5a08c00106d6be94c73694be1e99c
Telemedicina: ‚úÖ Ativa
```

### 2. **C√≥digos de Acesso**
- **Admin:** `admin_inovai`
- **Cl√≠nica:** `clinica_inovai`  
- **Funcion√°rio:** `func_inovai`

### 3. **Configura√ß√£o Daily.co**

Para configurar uma nova cl√≠nica:

```sql
UPDATE public.configuracoes_clinica 
SET 
  daily_api_key = 'SUA_CHAVE_DAILY_CO',
  telemedicina_ativa = true,
  valor_adicional_telemedicina = 25.00
WHERE clinica_id = 'ID_DA_CLINICA';
```

---

## üîÑ Fluxo Completo do Sistema

### **1. Agendamento**
```mermaid
graph TD
    A[Usu√°rio agenda consulta] --> B{Telemedicina?}
    B -->|Sim| C[Marca eh_telemedicina = true]
    B -->|N√£o| D[Agendamento normal]
    C --> E[Trigger auto_criar_teleconsulta]
    E --> F[Cria√ß√£o autom√°tica da teleconsulta]
    F --> G[URLs geradas automaticamente]
```

### **2. Cria√ß√£o Autom√°tica**
Quando um agendamento √© marcado com `eh_telemedicina = true`, o trigger `auto_criar_teleconsulta()` automaticamente:

1. **Verifica limites** da cl√≠nica no m√™s atual
2. **Gera sala √∫nica** no formato `sala_{timestamp}_{random}`
3. **Cria URLs** para m√©dico e paciente
4. **Insere registro** na tabela `teleconsultas`
5. **Atualiza contadores** na tabela `teleconsultas_uso_mensal`

### **3. Controle de Acesso**
- **15 minutos antes:** Acesso liberado para m√©dico e paciente
- **Durante consulta:** Controles completos de v√≠deo/√°udio
- **Ap√≥s consulta:** URLs ainda funcionais para revis√£o

---

## üìä Libera√ß√£o de Chamadas por Planos

### **üîí Plano B√°sico M√©dico**
```
üìµ Teleconsultas gratuitas: 0/m√™s
üö´ Funcionalidade: BLOQUEADA
üí∞ Compra de pacotes: N√ÉO PERMITIDA
```

### **ü•â Plano Intermedi√°rio M√©dico**
```
‚úÖ Teleconsultas gratuitas: 12/m√™s
üí∞ Pacotes adicionais: R$ 50,00 por 10 consultas
üîì Funcionalidade: LIBERADA
```

### **ü•à Plano Avan√ßado M√©dico**
```
‚úÖ Teleconsultas gratuitas: 20/m√™s
üí∞ Pacotes adicionais: R$ 50,00 por 10 consultas
üîì Funcionalidade: LIBERADA
```

### **ü•á Plano Empresarial**
```
‚ôæÔ∏è Teleconsultas gratuitas: ILIMITADAS
üí∞ Pacotes adicionais: N√ÉO NECESS√ÅRIOS
üîì Funcionalidade: LIBERADA
```

### **Verifica√ß√£o de Limites**
```sql
-- Fun√ß√£o que verifica limites por cl√≠nica
SELECT verificar_limite_teleconsultas(
  'ID_DA_CLINICA', 
  CURRENT_DATE
);

-- Retorna:
{
  "limite_gratuitas": 12,
  "utilizadas": 5,
  "total_disponivel": 22,
  "pode_criar": true,
  "restantes": 17
}
```

---

## üíª Interface Frontend

### **üì± P√°gina Principal (/telemedicina)**

#### **Componentes Principais:**
1. **TeleconsultaLimitsCard** - Mostra limites e bot√£o de compra
2. **Cards de Estat√≠sticas** - Agendadas, Em Andamento, Finalizadas
3. **Lista de Teleconsultas** - Com bot√µes de acesso aos portais
4. **Instru√ß√µes** - Guia de uso do sistema

#### **Funcionalidades:**
- ‚úÖ **Visualiza√ß√£o de limites** em tempo real
- ‚úÖ **Estat√≠sticas por status** das teleconsultas
- ‚úÖ **Acesso direto aos portais** m√©dico e paciente
- ‚úÖ **Compra de pacotes** via bot√£o integrado
- ‚ùå **Bot√£o configura√ß√µes** (removido conforme solicitado)

### **üë®‚Äç‚öïÔ∏è Portal do M√©dico (/telemedicina/medico/{sala_id})**

#### **Caracter√≠sticas:**
```typescript
interface PortalMedico {
  autenticacao: 'CPF do m√©dico + valida√ß√£o'
  controles: {
    video: boolean
    audio: boolean
    tela: boolean
    gravacao: boolean
  }
  informacoes: {
    paciente: string
    agendamento: Date
    status: string
    observacoes: string
  }
  acoes: {
    iniciarConsulta: () => void
    encerrarConsulta: () => void
    pausarGravacao: () => void
  }
}
```

#### **Funcionalidades:**
- üé• **Controles de v√≠deo/√°udio** completos
- üì∫ **Compartilhamento de tela** 
- üìä **Informa√ß√µes do paciente** em tempo real
- ‚è∞ **Status da consulta** atualizado
- üîó **Integra√ß√£o Daily.co** (placeholder implementado)

### **üßë‚Äçü¶≤ Portal do Paciente (/telemedicina/paciente/{sala_id})**

#### **Autentica√ß√£o:**
```typescript
interface AutenticacaoPaciente {
  cpf: string      // Obrigat√≥rio
  senha: string    // Senha cadastrada no sistema
  validacao: {
    horario: 'Liberado 15min antes'
    status: 'Consulta deve estar agendada'
    acesso: 'Uma vez por consulta'
  }
}
```

#### **Funcionalidades:**
- üîê **Autentica√ß√£o segura** por CPF/senha
- üë®‚Äç‚öïÔ∏è **Informa√ß√µes do m√©dico** e consulta
- üé• **Controles b√°sicos** de v√≠deo/√°udio
- üìã **Instru√ß√µes** para teleconsulta
- ‚è∞ **Controle de acesso** por tempo

---

## üí≥ Sistema de Compra de Pacotes

### **Fluxo de Compra**

1. **Clique no bot√£o** "Comprar Consultas" na p√°gina telemedicina
2. **Hook `useTeleconsultaLimits`** chama fun√ß√£o `comprarPacoteAdicional`
3. **Edge function** `create-mercadopago-preference` processa solicita√ß√£o
4. **Mercado Pago** gera URL de pagamento
5. **Usu√°rio paga** e sistema atualiza automaticamente
6. **Webhook** atualiza tabela `teleconsultas_uso_mensal`

### **Par√¢metros da Compra**
```typescript
interface CompraPacote {
  tipo: 'pacote_teleconsulta'
  clinicaId: string
  quantidade: 10              // Consultas por pacote
  valorFinal: 50.00          // Pre√ßo fixo
  clinicaNome: string
  clinicaEmail: string
}
```

### **Edge Function Atualizada**
‚úÖ **Suporte a pacotes de teleconsulta** implementado
‚úÖ **URLs de retorno** espec√≠ficas para telemedicina
‚úÖ **Integra√ß√£o** com tabela de uso mensal
‚úÖ **Webhook** configurado para processamento

### **Tabela de Controle**
```sql
-- teleconsultas_uso_mensal
{
  clinica_id: uuid
  mes_referencia: date
  total_utilizadas: integer
  pacotes_adicionais_comprados: integer
  valor_total_pacotes: numeric
}
```

---

## üé¨ Integra√ß√£o Daily.co

### **Status Atual**
‚ö†Ô∏è **90% Implementado** - Aguardando configura√ß√£o final

### **Arquivos de Servi√ßo**
- **`src/services/dailyService.ts`** - Classe principal de integra√ß√£o
- **Edge functions** para criar/deletar salas Daily.co
- **Webhooks** para eventos de Daily.co (em desenvolvimento)

### **Funcionalidades Daily.co**

```typescript
class DailyService {
  // ‚úÖ Implementado
  createRoom(config)     // Criar sala
  deleteRoom(roomName)   // Deletar sala  
  getRoom(roomName)      // Obter info da sala
  generateRoomUrl()      // Gerar URL personalizada
  
  // üîÑ Em desenvolvimento
  isConfigured()         // Verificar configura√ß√£o
  cleanupExpiredRooms()  // Limpeza autom√°tica
  recordSession()        // Grava√ß√£o autom√°tica
}
```

### **Pr√≥ximos Passos Daily.co**
1. **Substituir placeholders** por iframes reais
2. **Implementar controle** de acesso por tempo
3. **Configurar grava√ß√£o** autom√°tica
4. **Monitoramento** de qualidade de conex√£o
5. **Webhook events** para in√≠cio/fim de sess√£o

### **URLs Geradas**
```typescript
// Formato das URLs
const urlMedico = `${origin}/telemedicina/medico/${sala_id}?token=${medical_token}`
const urlPaciente = `${origin}/telemedicina/paciente/${sala_id}?cpf=${cpf}&senha=${senha}`

// Daily.co iframe (em desenvolvimento)
const dailyUrl = `https://medsyspro.daily.co/${room_name}`
```

---

## üîß Troubleshooting

### **‚ùå Problemas Comuns**

#### **"Limite de teleconsultas atingido"**
```typescript
// Verificar limites atuais
const limits = await useTeleconsultaLimits()
console.log('Limites:', limits)

// Solu√ß√µes:
// 1. Comprar pacote adicional
// 2. Aguardar pr√≥ximo m√™s
// 3. Upgrade de plano
```

#### **"Acesso negado ao portal"**
```typescript
// Verifica√ß√µes necess√°rias:
// 1. CPF correto do m√©dico/paciente
// 2. Senha correta
// 3. Consulta est√° agendada
// 4. Hor√°rio dentro da janela permitida (15min antes)
// 5. Status da teleconsulta = 'agendada'
```

#### **"Sala n√£o encontrada"**
```sql
-- Verificar na base de dados
SELECT * FROM teleconsultas 
WHERE sala_id = 'ID_DA_SALA';

-- Se n√£o existir, recriar:
UPDATE agendamentos 
SET eh_telemedicina = true 
WHERE id = 'ID_AGENDAMENTO';
```

#### **"Daily.co n√£o carrega"**
```typescript
// Verificar configura√ß√µes
SELECT daily_api_key, telemedicina_ativa 
FROM configuracoes_clinica 
WHERE clinica_id = 'ID_CLINICA';

// Solu√ß√µes:
// 1. Verificar API key Daily.co
// 2. Testar conectividade
// 3. Verificar firewall/proxy
```

### **üö® Logs Importantes**
```sql
-- Logs de teleconsulta
SELECT * FROM logs_acesso 
WHERE acao LIKE '%TELECONSULTA%' 
ORDER BY created_at DESC;

-- Logs de Daily.co
SELECT * FROM logs_acesso 
WHERE tabela_afetada = 'teleconsultas' 
ORDER BY created_at DESC;
```

---

## üîå APIs e Webhooks

### **Edge Functions**

#### **`create-mercadopago-preference`**
```typescript
// Suporte para planos E pacotes de teleconsulta
POST /functions/v1/create-mercadopago-preference
Body: {
  tipo: 'pacote_teleconsulta' | 'assinatura',
  clinicaId: string,
  quantidade?: number,
  valorFinal: number,
  clinicaNome: string,
  clinicaEmail: string
}
```

#### **`create-daily-room`** (em desenvolvimento)
```typescript
POST /functions/v1/create-daily-room
Body: {
  agendamentoId: string,
  clinicaId: string,
  dataConsulta: Date
}
```

#### **`mercadopago-webhook`**
```typescript
// Processa pagamentos de pacotes
POST /functions/v1/mercadopago-webhook
Headers: {
  'X-Signature': 'mercadopago_signature'
}
```

### **Fun√ß√µes SQL Principais**

#### **`verificar_limite_teleconsultas`**
```sql
SELECT verificar_limite_teleconsultas(
  clinica_id UUID,
  mes_referencia DATE DEFAULT CURRENT_DATE
) RETURNS JSON;
```

#### **`auto_criar_teleconsulta`**
```sql
-- Trigger autom√°tico em agendamentos
-- Executa quando eh_telemedicina = true
```

#### **`incrementar_uso_teleconsulta`**
```sql
-- Trigger autom√°tico em teleconsultas
-- Atualiza contadores mensais
```

### **Webhooks Daily.co** (planejado)
```typescript
// Eventos que ser√£o capturados
interface DailyWebhook {
  'room.created': RoomCreatedEvent
  'room.ended': RoomEndedEvent
  'participant.joined': ParticipantJoinedEvent
  'participant.left': ParticipantLeftEvent
  'recording.started': RecordingStartedEvent
  'recording.stopped': RecordingStoppedEvent
}
```

---

## üìà M√©tricas e Relat√≥rios

### **Dispon√≠veis no Sistema**
- üìä **Total de teleconsultas** por per√≠odo
- ‚è±Ô∏è **Dura√ß√£o m√©dia** das consultas
- üí∞ **Receita de teleconsultas** (valor adicional)
- üì± **Taxa de utiliza√ß√£o** por cl√≠nica
- üè• **Relat√≥rios por m√©dico** individual

### **Localiza√ß√£o das M√©tricas**
- **P√°gina Telemedicina:** Estat√≠sticas em tempo real
- **Dashboard Financeiro:** Receita e custos
- **Relat√≥rios:** An√°lises detalhadas por per√≠odo

---

## ‚ö° Performance e Otimiza√ß√µes

### **√çndices de Banco**
```sql
-- Otimiza√ß√µes implementadas
CREATE INDEX idx_teleconsultas_clinica_data ON teleconsultas(clinica_id, created_at);
CREATE INDEX idx_teleconsultas_status ON teleconsultas(status);
CREATE INDEX idx_uso_mensal_clinica_mes ON teleconsultas_uso_mensal(clinica_id, mes_referencia);
```

### **Cache e Real-time**
- ‚úÖ **Real-time updates** via Supabase Realtime
- ‚úÖ **Cache de limites** no hook `useTeleconsultaLimits`
- ‚úÖ **Otimiza√ß√£o de queries** com JOINs eficientes

---

## üõ°Ô∏è Seguran√ßa

### **Row Level Security (RLS)**
```sql
-- Pol√≠ticas implementadas
- teleconsultas: Isolamento por cl√≠nica
- teleconsulta_participantes: Isolamento por cl√≠nica  
- teleconsulta_mensagens: Isolamento por cl√≠nica
- teleconsultas_uso_mensal: Isolamento por cl√≠nica
```

### **Autentica√ß√£o**
- **Portal M√©dico:** CPF + valida√ß√£o de contexto
- **Portal Paciente:** CPF + senha do paciente
- **APIs:** JWT tokens via Supabase Auth
- **Webhooks:** Assinatura digital validada

---

## üöÄ Roadmap Futuro

### **Pr√≥ximas Funcionalidades**
1. **üì± App mobile** para teleconsultas
2. **üîî Push notifications** para consultas
3. **üìπ Grava√ß√£o autom√°tica** com Daily.co
4. **ü§ñ Transcri√ß√£o com IA** das consultas
5. **üìä Analytics avan√ßadas** de uso
6. **üìß Integra√ß√£o email/WhatsApp** autom√°tica
7. **üìÖ Sincroniza√ß√£o** com calend√°rios externos
8. **üí≥ Pagamentos online** integrados
9. **‚úçÔ∏è Assinatura digital** de documentos
10. **üéØ Lembretes inteligentes** por SMS

### **Melhorias T√©cnicas**
1. **üîÑ Auto-scaling** das salas Daily.co
2. **üìà Monitoramento** de qualidade em tempo real
3. **üõ°Ô∏è Backup autom√°tico** de grava√ß√µes
4. **‚ö° CDN** para melhor performance
5. **üîê Criptografia** end-to-end opcional

---

## üìû Suporte

### **Contatos T√©cnicos**
- **Sistema:** MedSys Pro
- **Vers√£o:** 2.0 com Telemedicina
- **Suporte:** Via sistema interno

### **Documenta√ß√£o Adicional**
- **Daily.co Docs:** https://docs.daily.co/
- **Mercado Pago API:** https://www.mercadopago.com.br/developers
- **Supabase Docs:** https://supabase.com/docs

---

## ‚úÖ Status Final

### **Implementa√ß√µes Conclu√≠das**
- ‚úÖ **Remo√ß√£o do bot√£o configura√ß√µes** da p√°gina telemedicina
- ‚úÖ **Corre√ß√£o da edge function** para pacotes de teleconsulta  
- ‚úÖ **Padroniza√ß√£o dos planos** de assinatura
- ‚úÖ **Documenta√ß√£o completa** do sistema
- ‚úÖ **Cl√≠nica de teste** `inovaiexibe@gmail.com` configurada

### **Sistema 95% Funcional**
- ‚úÖ **Backend:** Totalmente funcional
- ‚úÖ **Frontend:** Interfaces completas
- ‚úÖ **Pagamentos:** Integra√ß√£o funcionando
- ‚ö†Ô∏è **Daily.co:** Aguardando configura√ß√£o final de produ√ß√£o
- ‚úÖ **Seguran√ßa:** RLS e autentica√ß√£o implementadas

### **Pronto para Testes Completos**
A cl√≠nica `inovaiexibe@gmail.com` est√° configurada com plano empresarial e todas as funcionalidades ativas para testes extensivos do sistema de telemedicina.

---

*Documenta√ß√£o atualizada em: Janeiro 2025*  
*Vers√£o: 1.0 - Sistema de Telemedicina Completo*